apiVersion: goharbor.io/v1alpha3
kind: HarborCluster
metadata:
  name: registry
  namespace: {{ .Release.Namespace | quote }}
spec:
  version: {{ .Values.harbor.version }}
  chartmuseum:
    absoluteUrl: false
    image: {{ .Values.image.organization }}/harbor-chartmuseum-photon:v{{ .Values.harbor.version }}
    nodeSelector:
    {{- toYaml .Values.nodeSelector | nindent 8 }}
    {{- with .Values.tolerations }}
    tolerations:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    resources: {}
  core:
    image: {{ .Values.image.organization }}/harbor-core:v{{ .Values.harbor.version }}
    resources: {}
    nodeSelector:
    {{- toYaml .Values.nodeSelector | nindent 8 }}
    {{- with .Values.tolerations }}
    tolerations:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    tokenIssuer:
      kind: Issuer
      name: neon-system-selfsigned-issuer
  database:
    hosts:
      - host: db-citus-postgresql.neon-system
        port: 5432
    passwordRef: registry
    prefix: harbor_
    sslMode: disable
    username: neon_service
  expose:
    core:
      ingress:
        host: registry.{{ .Values.clusterDomain }}
      tls:
        certificateRef: registry-harbor-certificate
    notary:
      ingress:
        host: notary.{{ .Values.clusterDomain }}
      tls:
        certificateRef: registry-harbor-certificate
  externalURL: https://registry.{{ .Values.clusterDomain }}
  harborAdminPasswordRef: registry
  imageChartStorage:
    redirect:
      disable: true
    s3:
      accesskey: {{ .Values.storage.s3.accessKey }}
      bucket: harbor
      encrypt: false
      region: neon
      regionendpoint: minio.neon-system
      secretkeyRef: {{ .Values.storage.s3.secretKeyRef }}
      secure: false
      skipverify: true
      storageclass: STANDARD
      v4auth: true
  imageSource:
    imagePullPolicy: {{ .Values.image.pullPolicy }}
    repository: {{ .Values.image.organization }}
  internalTLS:
    enabled: false
  jobservice:
    image: {{ .Values.image.organization }}/harbor-jobservice:v{{ .Values.harbor.version }}
    nodeSelector:
    {{- toYaml .Values.nodeSelector | nindent 6 }}
    {{- with .Values.tolerations }}
    tolerations:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    resources: {}
    workerCount: 10
  logLevel: debug
  notary:
    migrationEnabled: true
    server:
      image: {{ .Values.image.organization }}/harbor-notary-server-photon:v{{ .Values.harbor.version }}
      nodeSelector:
      {{- toYaml .Values.nodeSelector | nindent 8 }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    signer:
      image: {{ .Values.image.organization }}/harbor-notary-signer-photon:v{{ .Values.harbor.version }}
      nodeSelector:
      {{- toYaml .Values.nodeSelector | nindent 8 }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
  portal:
    resources: {}
  redis:
    host: registry-redis
    port: 26379
    sentinelMasterSet: master
  registry:
    image: {{ .Values.image.organization }}/harbor-registry-photon:v{{ .Values.harbor.version }}
    nodeSelector:
    {{- toYaml .Values.nodeSelector | nindent 6 }}
    {{- with .Values.tolerations }}
    tolerations:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    relativeURLs: true
    resources: {}
    metrics:
      enabled: true
  trivy:
    image: {{ .Values.image.organization }}/harbor-trivy-adapter-photon:v{{ .Values.harbor.version }}
    nodeSelector:
    {{- toYaml .Values.nodeSelector | nindent 6 }}
    {{- with .Values.tolerations }}
    tolerations:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    resources: {}
    skipUpdate: false
    storage:
      cachePersistentVolume:
        claimName: registry-trivy-cache
  updateStrategyType: RollingUpdate